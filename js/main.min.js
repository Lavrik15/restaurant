$(document).ready(function(){
    var $document = $(document);
    var $body = $("body");
    var $menu = $(".nav__wrapper");
    var $shadow = $(".nav__shadow");
    var $menu_btn = $(".nav__menu-btn");
    var $filter = $(".filter-btn");
    var $filter_shadow = $(".filter__shadow");
    var $filter_wrapper = $(".filter__wrapper");
    var $backdoor = $(".backdoor");
    var $filter_inner = $(".filter__inner");
    var $catalog = $(".catalog");
    var $order = $(".order");
    var vm_swipe = $(".vm-swipe-inner");
    var $filter_item = $(".filter__item");
    var $filter_link = $(".filter__item-link");

    set_filter_size();
    
    svg4everybody();

    $menu_btn.on("click", open_menu);
    $filter.on("click", open_filter);

    $backdoor.on("click", function(){
        close_menu();
        close_filter();
    });

    $filter_link.on("click", function (event) {
        event.preventDefault();

        close_filter();
        $filter_item.removeClass("filter__item--active");
        $(this).parent().addClass("filter__item--active");
        
        var elementClick = $(this).attr("data-scroll");
        var destination = $("." + elementClick).offset().top;
        jQuery("html:not(:animated),body:not(:animated)").animate({ scrollTop: destination }, 400);
    });

    $(window).resize(set_filter_size);
 
    $(window).resize(function() {
        if ($(window).width() < 1024) $(".swipe").vmSwipe("destroy");    
        if ($(window).width() > 1024) $(".swipe").vmSwipe({direcion: "horizontal"});
    });

    if ($(window).width() > 1024) $(".swipe").vmSwipe({ direcion: "horizontal" });

    function open_filter() {
        $filter_wrapper.addClass("filter__wrapper--active");
        $filter_shadow.removeClass("hidden");
        $backdoor.addClass("active");
        $body.toggleClass("overflow-hidden");
    }

    function close_filter() {
        $filter_wrapper.removeClass("filter__wrapper--active");
        $filter_shadow.addClass("hidden");
        $backdoor.removeClass("active");
        $body.removeClass("overflow-hidden");
    }

    function open_menu() {
        $menu.addClass("nav__wrapper--active");
        $shadow.removeClass("hidden");
        $backdoor.addClass("active");
        $body.addClass("overflow-hidden");
    }
    function close_menu() {
        $menu.removeClass("nav__wrapper--active");
        $shadow.addClass("hidden");
        $backdoor.removeClass("active");
        $body.removeClass("overflow-hidden");
    }
    function set_filter_size() {
        $filter_shadow.width($body.width() - $order.outerWidth() - 21);
    }
});

console.log("asd");
( function( $ ){
  // Constants
  var $vm_swipe = $(".vm-swipe");
  var PLUGIN_NS = 'vmSwipe',
      LEFT = 'left',
      RIGHT = 'right',
      UP = 'up',
      DOWN = 'down',
  
      NONE = 'none';
  
  var defaults = {
    direction: 'horizontal',
    inertiaMaxWidth: 1030,
    inertiaThreshold: 25,
    activeElements: [ 'a' ]
  };
  
  $.fn.vmSwipe = function( method ){
    var it = $( this ),
        plugin = it.data( PLUGIN_NS );
    
    if ( plugin && typeof method === 'string') {
      if( plugin[method] ) return plugin[method].apply( this, Array.prototype.slice.call( arguments, 1 ));
      else $.error( 'Метод с именем ' +  method + ' не существует для jQuery.vmSlider' );
    }
    else if ( plugin && typeof method === 'object' ) plugin['option'].apply( plugin, arguments );
    else if( typeof method === 'object' || !method ) return init.apply( this, arguments );
    
    return it;
  };
  
  $.fn.vmSwipe.defaults = defaults;
  
  function init( options ){
    if ( !options ) options = {};
    options = $.extend( {}, $.fn.vmSwipe.defaults, options );
    
    return this.each( function(){
      var it = $( this );
      
      var plugin = it.data( PLUGIN_NS );
      
      if ( !plugin ) {
        plugin = new VmSwipe( it, options );
        it.data( PLUGIN_NS, plugin );
      }
    });
  }
  
  function VmSwipe( element, options ){
    var options = $.extend( {}, options );
    
    var supports = {
      transition: null,
      animation: null,
      transform: null
    };
    
    var position = {
      x: 0,
      y: 0
    };
    
    // Touch properties
    var distance = 0,
        currentDistance = null,
        direction = null,
        currentDirection = null,
        duration = {},
        speed = {};
    
    // Finger data object
    var fingerData = {};
    
    // Direction of swipe (horizontal, vertical, both)
    var swipeDirection = options.direction;
    
    // Support css properties
    support( supports );
    
    // Track times
    var startTime = 0,
        endTime = 0,
        endMoveTime = 0;
  
    // Inertia mobile
    var withoutInertia,
        startTimeMobile;
    
    // Add wrapper
    wrapContent( element );
    var innerWrapper = element.find( '.vm-swipe-inner' );
    
    try {
      element.on( 'touchstart.vmswipe mousedown.vmswipe', touchStart );
      element.on( 'touchcancel.vmswipe', touchEnd );
    }
    catch( event ){
      $.error( 'events not supported on jQuery.swipe' );
    }
    
    // Public methods
    this.destroy = function(){
      removeListeners();
      element.data( PLUGIN_NS, null );
      innerWrapper.children().unwrap();
    };
    this.refresh = function(){
      switch( swipeDirection ){
        case 'horizontal':
          innerWrapper.width( getWrapperWidth( innerWrapper ) );
          position.x = getPosition( innerWrapper.outerWidth(), element.outerWidth(), position.x );
          break;
          
        case 'vertical':
          innerWrapper.height( getWrapperHeight( innerWrapper ) );
          position.y = getPosition( innerWrapper.outerHeight(), element.outerHeight(), position.y );
          break;
          
        case 'both':
          innerWrapper.width( getWrapperWidth( innerWrapper ) );
          innerWrapper.height( getWrapperHeight( innerWrapper ) );
          position.x = getPosition( innerWrapper.outerWidth(), element.outerWidth(), position.x );
          position.y = getPosition( innerWrapper.outerHeight(), element.outerHeight(), position.y );
          break;
      }
  
      innerWrapper.css({ 'transform': 'translate3d(' + position.x  + 'px, ' + position.y  + 'px, 0px)' });
    };
    
    function touchStart( event ){
      // Check if this element matches any in the excluded elements selectors, or its parent is excluded, if so, DON'T swipe
      if( isActiveElements( $( event.target ) ) ) return;
  
      event.preventDefault();
      event = event.originalEvent ? event.originalEvent : event;

      var touches = event.touches;
      event = touches ? touches[0] : event;

      distance = 0;
      currentDistance = 0;
      direction = null;
      currentDirection = null;
      duration = {};
      startTime = 0;
      endTime = 0;
      speed = {};
      withoutInertia = null;
      startTimeMobile = 0;

      element.toggleClass( 'moving', event.type === 'mousedown');

      getCurrentPosition();
      createFingerData( event );

      innerWrapper.stop();

      $( document ).on( 'touchend.vmswipe mouseup.vmswipe', $.proxy( touchEnd, element ) );
      $( document ).on( 'touchmove.vmswipe mousemove.vmswipe', $.proxy( touchMove, element ) );
    }
    function touchMove( event ){
      event = event.originalEvent ? event.originalEvent : event;
      
      var touches = event.touches;
      event = touches ? touches[0] : event;
      
      updateFingerData( event );
      startSwipeTime();
      
      endTime = endMoveTime = getTimeStamp();
      currentDirection = calculateDirection( fingerData.last, fingerData.end );
      currentDistance = calculateCurrentDistance( fingerData.end, fingerData.last );
      distance = calculateCurrentDistance( fingerData.end, fingerData.start );
      withoutInertia = isReallyFingerMoving();
      
      changePosition( innerWrapper, currentDirection, currentDistance, position );
    }
    function touchEnd(){
      endTime = getTimeStamp();
      duration = calculateDuration();
      speed = calculateSpeed( distance, duration );
  
      inertia();
      element.removeClass( 'moving' );
      
      $( document ).off( 'touchmove.vmswipe mousemove.vmswipe', $.proxy( touchMove, element ) );
      $( document ).off( 'touchend.vmswipe mouseup.vmswipe', $.proxy( touchEnd, element ) );
    }
    
    winWidthResize( null, function(){
      switch( swipeDirection ){
        case 'horizontal':
          position.x = getPosition( innerWrapper.outerWidth(), element.outerWidth(), position.x );
          break;
    
        case 'vertical':
          position.y = getPosition( innerWrapper.outerHeight(), element.outerHeight(), position.y );
          break;
    
        case 'both':
          position.x = getPosition( innerWrapper.outerWidth(), element.outerWidth(), position.x );
          position.y = getPosition( innerWrapper.outerHeight(), element.outerHeight(), position.y );
          break;
      }
  
      innerWrapper.css({ 'transform': 'translate3d(' + position.x  + 'px, ' + position.y  + 'px, 0px)' });
    });
    
    
    // Helpers
    function winWidthResize( context, func ){
      var timerId,
          windowWidth = $( window ).width(),
          arg = [].slice.call( arguments, 2 );
      
      $( window ).resize( function(){
        if ( windowWidth === $( window ).width() ) return;
        if( timerId ) clearTimeout( timerId );
        
        windowWidth = $( window ).width();
        
        // This function was called once after resize event
        timerId = setTimeout( function(){
          func.apply( context, arg );
          clearTimeout( timerId );
        }, 150);
      });
    }
    function getCurrentPosition(){
      if( supports.transform ){
        position = innerWrapper.css( 'transform' ).replace( /.*\(|\)| /g, '' ).split( ',' );
        position = {
          x: +position[position.length === 16 ? 12 : 4],
          y: +position[position.length === 16 ? 13 : 5]
        };
      }
      else{
        position = innerWrapper.position();
        position = {
          x: +position.left,
          y: +position.top
        };
      }
    }
    function wrapContent( element ){
      element.contents().wrapAll( createWrapper() );
    }
    function createWrapper(){
      var wrapper = $( '<div />',{
        'class': 'vm-swipe-inner'
      });
      wrapper.css({
        'width': ( options.direction === 'horizontal' || options.direction === 'both' ) ? getWrapperWidth( element ) : '',
        'height': ( options.direction === 'vertical' || options.direction === 'both' ) ? getWrapperHeight( element ) : '',
        'transform': 'translate3d(0px, 0px, 0px)'
      
      });
      return wrapper;
    }
    function getWrapperWidth( element ){
      var width = 0;
    
      element.find($vm_swipe).children().each( function(){
        var it = $( this );
        width += it.outerWidth( true );
      });
      return width + 120;
    }
    function getWrapperHeight( element ){
      var height = 0;
    
      element.children().each( function(){
        var it = $( this );
        height += it.outerHeight( true );
      });
    
      return height;
    }
    function createFingerData( event ) {
      var f = {
        start: {
          x: 0,
          y: 0
        },
        last: {
          x: 0,
          y: 0
        },
        end: {
          x: 0,
          y: 0
        }
      };
      f.start.x = f.last.x = f.end.x = event.pageX || event.clientX;
      f.start.y = f.last.y = f.end.y = event.pageY || event.clientY;
      fingerData = f;
      return f;
    }
    function updateFingerData( event ){
      if ( !Object.keys( fingerData ).length ) createFingerData( event );
      
      fingerData.last.x = fingerData.end.x;
      fingerData.last.y = fingerData.end.y;
      
      fingerData.end.x = event.pageX || event.clientX;
      fingerData.end.y = event.pageY || event.clientY;
      
      return fingerData;
    }
    function changePosition( innerWrapper, currentDirection, currentDistance, position ){
      switch( swipeDirection ){
        case 'horizontal':
          if( currentDirection === 'up' || currentDirection === 'down' ) return;
          position.x += currentDistance.x;
          position.x = getPosition( innerWrapper.outerWidth(), element.outerWidth(), position.x );
          break;
  
        case 'vertical':
          if( currentDirection === 'left' || currentDirection === 'right' ) return;
          position.y += currentDistance.y;
          position.y = getPosition( innerWrapper.outerHeight(), element.outerHeight(), position.y );
          break;
  
        case 'both':
          position.x += currentDistance.x;
          position.y += currentDistance.y;
          position.x = getPosition( innerWrapper.outerWidth(), element.outerWidth(), position.x );
          position.y = getPosition( innerWrapper.outerHeight(), element.outerHeight(), position.y );
          break;
      }
      
      innerWrapper.css({ 'transform': 'translate3d(' + position.x + 'px, ' + position.y + 'px, 0px)' });
    }
    function getPosition( wrapperDimensions, elementDimentions, position ){
      if( wrapperDimensions <= elementDimentions ) return 0;
      if( position > 0 ) position = 0;
      if( Math.abs( position ) > ( wrapperDimensions - elementDimentions ) ) position = -( wrapperDimensions - elementDimentions );
      return position;
    }
    function support( values ){
      var styles = $( '<support />' ).get( 0 ).style;
      $.each( values, function( key, value ){
        if( styles[key] !== undefined ) values[key] = true;
      });
    }
    function getTimeStamp() {
      return new Date().getTime();
    }
    function calculateDirection( startPoint, endPoint ){
      if( comparePoints( startPoint, endPoint ) ) return NONE;
      
      var angle = calculateAngle( startPoint, endPoint );
      
      if( ( angle <= 45 ) && ( angle >= 0 ) ) return LEFT;
      else if( ( angle <= 360 ) && ( angle >= 315 ) ) return LEFT;
      else if( ( angle >= 135 ) && ( angle <= 225 ) ) return RIGHT;
      else if( ( angle > 45 ) && ( angle < 135 ) ) return DOWN;
      else return UP;
    }
    function comparePoints( pointA, pointB ){
      return ( pointA.x === pointB.x && pointA.y === pointB.y );
    }
    function calculateAngle( startPoint, endPoint ){
      var x = startPoint.x - endPoint.x,
          y = endPoint.y - startPoint.y,
          r = Math.atan2( y, x ), //radians
          angle = Math.round( r * 180 / Math.PI ); //degrees
      
      //ensure value is positive
      if( angle < 0 ) angle = 360 - Math.abs(angle);
      
      return angle;
    }
    function calculateCurrentDistance( startPoint, endPoint ){
      return {
        x: startPoint.x - endPoint.x,
        y: startPoint.y - endPoint.y
      }
    }
    function calculateSpeed( distance, time ){
      return {
        x: distance.x / time,
        y: distance.y / time
      }
    }
    function calculateDuration() {
      var duration;
      if( !startTime ) duration = 0;
      else duration = endTime - startTime;
      return duration;
    }
    function removeListeners(){
      $( document ).off( '.vmswipe' );
      element.off( '.vmswipe' );
    }
    function startSwipeTime(){
      if( endTime )return;
      startTime = getTimeStamp();
    }
    function isReallyFingerMoving(){
      var currentTimeMobile = getTimeStamp(),
          absDistance,
          deltaTime;
    
      if( !startTimeMobile ) startTimeMobile = currentTimeMobile;
  
      switch( swipeDirection ){
        case 'horizontal':
          absDistance = Math.abs( fingerData.end.x - fingerData.last.x );
          break;
  
        case 'vertical':
          absDistance = Math.abs( fingerData.end.y - fingerData.last.y );
          break;
  
        case 'both':
          absDistance = Math.max( Math.abs( fingerData.end.x - fingerData.last.x ), Math.abs( fingerData.end.y - fingerData.last.y ) );
          break;
      }
      
      deltaTime = currentTimeMobile - startTimeMobile;
      return ( absDistance < 10 ) && ( deltaTime > 100 );
    }
    function inertia(){
      var absDistance;
    
      switch( swipeDirection ){
        case 'horizontal':
          absDistance = Math.abs( distance.x );
          break;
      
        case 'vertical':
          absDistance = Math.abs( distance.y );
          break;
      
        case 'both':
          absDistance = Math.max( Math.abs( distance.x ), Math.abs( distance.y ) );
          break;
      }
      
      var isTimeForInertia = ( endTime - endMoveTime ) < 50;
      var isWidthForInertia = $( window ).width() <= options.inertiaMaxWidth;
      var isDistanceForInertia = absDistance > options.inertiaThreshold;
    
      if( ( isTimeForInertia && !withoutInertia ) && isWidthForInertia && isDistanceForInertia ) getInertia();
    }
    function getInertia(){
      innerWrapper.css({'text-indent': 100});
      innerWrapper.animate({
        textIndent: 0
      },
      {
        duration: ( Math.max( Math.abs( speed.x ), Math.abs( speed.y ) ) * 5000 ),
        step: function( currentStep ){
          var thisStepTime = getTimeStamp(),
              stepDuration = thisStepTime - endTime;
          
          endTime = thisStepTime;
          speed.x *= currentStep / 100;
          speed.y *= currentStep / 100;
  
          currentDistance.x = speed.x * stepDuration;
          currentDistance.y = speed.y * stepDuration;
    
          changePosition( innerWrapper, currentDirection, currentDistance, position );
        }
      });
    }
    function isActiveElements( element ){
      for( var i = 0, l = options.activeElements.length; i < l; i++ ){
        if( element.closest( options.activeElements[i], innerWrapper ).length ) return true;
      }
      return false;
    }
    function calculateDistance( startPoint, endPoint ){
      return Math.round( Math.sqrt( Math.pow( endPoint.x - startPoint.x, 2 ) + Math.pow( endPoint.y - startPoint.y, 2 ) ) );
    }
  }
  
})( jQuery );
$(document).ready(function(){
    var $body = $("body");
    var $popup_open_btn = $(".catalog__item-more");
    var $catalog_image = $(".catalog__image");
    var $popup_close_btn = $(".popup__close");
    var $header = $(".header"); 
    var $main = $(".main"); 
    var $popup = $(".popup");
    var $backdoor = $(".backdoor");

    $backdoor.on("click", function() {
        backdoor_blur_off();
        backdoor_off();
        close_popup();
    });
    $catalog_image.on("click", function () {
        $body.addClass("overflow-hidden padding-scroll");
        backdoor_on();
        backdoor_blur_on();
        open_popup();
    });
    $popup_open_btn.on("click", function(){
        $body.addClass("overflow-hidden padding-scroll");
        backdoor_on();
        backdoor_blur_on();
        open_popup();
    });
    $popup_close_btn.on("click", function(){
        $body.removeClass("overflow-hidden padding-scroll");
        backdoor_off();
        backdoor_blur_off();
        close_popup();
    });

    function backdoor_on() {
        $backdoor.addClass("active");
    }
    function backdoor_off() {
        $backdoor.removeClass("active");
    }
    function backdoor_blur_on() {
        $header.addClass("filter-blur");
        $main.addClass("filter-blur");
    }
    function backdoor_blur_off() {
        $header.removeClass("filter-blur");
        $main.removeClass("filter-blur");
    }
    function open_popup() {
        $popup.addClass("popup--active");
    }
    function close_popup() {
        $popup.removeClass("popup--active");
    }
});
!function (root, factory) {
    "function" == typeof define && define.amd ? // AMD. Register as an anonymous module unless amdModuleId is set
        define([], function () {
            return root.svg4everybody = factory();
        }) : "object" == typeof module && module.exports ? // Node. Does not work with strict CommonJS, but
            // only CommonJS-like environments that support module.exports,
            // like Node.
            module.exports = factory() : root.svg4everybody = factory();
}(this, function () {
    /*! svg4everybody v2.1.9 | github.com/jonathantneal/svg4everybody */
    function embed(parent, svg, target) {
        // if the target exists
        if (target) {
            // create a document fragment to hold the contents of the target
            var fragment = document.createDocumentFragment(), viewBox = !svg.hasAttribute("viewBox") && target.getAttribute("viewBox");
            // conditionally set the viewBox on the svg
            viewBox && svg.setAttribute("viewBox", viewBox);
            // copy the contents of the clone into the fragment
            for (// clone the target
                var clone = target.cloneNode(!0); clone.childNodes.length;) {
                fragment.appendChild(clone.firstChild);
            }
            // append the fragment into the svg
            parent.appendChild(fragment);
        }
    }
    function loadreadystatechange(xhr) {
        // listen to changes in the request
        xhr.onreadystatechange = function () {
            // if the request is ready
            if (4 === xhr.readyState) {
                // get the cached html document
                var cachedDocument = xhr._cachedDocument;
                // ensure the cached html document based on the xhr response
                cachedDocument || (cachedDocument = xhr._cachedDocument = document.implementation.createHTMLDocument(""),
                    cachedDocument.body.innerHTML = xhr.responseText, xhr._cachedTarget = {}), // clear the xhr embeds list and embed each item
                    xhr._embeds.splice(0).map(function (item) {
                        // get the cached target
                        var target = xhr._cachedTarget[item.id];
                        // ensure the cached target
                        target || (target = xhr._cachedTarget[item.id] = cachedDocument.getElementById(item.id)),
                            // embed the target into the svg
                            embed(item.parent, item.svg, target);
                    });
            }
        }, // test the ready state change immediately
            xhr.onreadystatechange();
    }
    function svg4everybody(rawopts) {
        function oninterval() {
            // while the index exists in the live <use> collection
            for (// get the cached <use> index
                var index = 0; index < uses.length;) {
                // get the current <use>
                var use = uses[index], parent = use.parentNode, svg = getSVGAncestor(parent), src = use.getAttribute("xlink:href") || use.getAttribute("href");
                if (!src && opts.attributeName && (src = use.getAttribute(opts.attributeName)),
                    svg && src) {
                    if (polyfill) {
                        if (!opts.validate || opts.validate(src, svg, use)) {
                            // remove the <use> element
                            parent.removeChild(use);
                            // parse the src and get the url and id
                            var srcSplit = src.split("#"), url = srcSplit.shift(), id = srcSplit.join("#");
                            // if the link is external
                            if (url.length) {
                                // get the cached xhr request
                                var xhr = requests[url];
                                // ensure the xhr request exists
                                xhr || (xhr = requests[url] = new XMLHttpRequest(), xhr.open("GET", url), xhr.send(),
                                    xhr._embeds = []), // add the svg and id as an item to the xhr embeds list
                                    xhr._embeds.push({
                                        parent: parent,
                                        svg: svg,
                                        id: id
                                    }), // prepare the xhr ready state change event
                                    loadreadystatechange(xhr);
                            } else {
                                // embed the local id into the svg
                                embed(parent, svg, document.getElementById(id));
                            }
                        } else {
                            // increase the index when the previous value was not "valid"
                            ++index, ++numberOfSvgUseElementsToBypass;
                        }
                    }
                } else {
                    // increase the index when the previous value was not "valid"
                    ++index;
                }
            }
            // continue the interval
            (!uses.length || uses.length - numberOfSvgUseElementsToBypass > 0) && requestAnimationFrame(oninterval, 67);
        }
        var polyfill, opts = Object(rawopts), newerIEUA = /\bTrident\/[567]\b|\bMSIE (?:9|10)\.0\b/, webkitUA = /\bAppleWebKit\/(\d+)\b/, olderEdgeUA = /\bEdge\/12\.(\d+)\b/, edgeUA = /\bEdge\/.(\d+)\b/, inIframe = window.top !== window.self;
        polyfill = "polyfill" in opts ? opts.polyfill : newerIEUA.test(navigator.userAgent) || (navigator.userAgent.match(olderEdgeUA) || [])[1] < 10547 || (navigator.userAgent.match(webkitUA) || [])[1] < 537 || edgeUA.test(navigator.userAgent) && inIframe;
        // create xhr requests object
        var requests = {}, requestAnimationFrame = window.requestAnimationFrame || setTimeout, uses = document.getElementsByTagName("use"), numberOfSvgUseElementsToBypass = 0;
        // conditionally start the interval if the polyfill is active
        polyfill && oninterval();
    }
    function getSVGAncestor(node) {
        for (var svg = node; "svg" !== svg.nodeName.toLowerCase() && (svg = svg.parentNode);) { }
        return svg;
    }
    return svg4everybody;
});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImpzL2NvbW1vbi5qcyIsImpzL2pxdWVyeS52bVN3aXBlLmpzIiwianMvcG9wdXAuanMiLCJqcy9zdmc0ZXZlcnlib2R5LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUMvRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNuZUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUN0REE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoibWFpbi5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyIkKGRvY3VtZW50KS5yZWFkeShmdW5jdGlvbigpe1xyXG4gICAgdmFyICRkb2N1bWVudCA9ICQoZG9jdW1lbnQpO1xyXG4gICAgdmFyICRib2R5ID0gJChcImJvZHlcIik7XHJcbiAgICB2YXIgJG1lbnUgPSAkKFwiLm5hdl9fd3JhcHBlclwiKTtcclxuICAgIHZhciAkc2hhZG93ID0gJChcIi5uYXZfX3NoYWRvd1wiKTtcclxuICAgIHZhciAkbWVudV9idG4gPSAkKFwiLm5hdl9fbWVudS1idG5cIik7XHJcbiAgICB2YXIgJGZpbHRlciA9ICQoXCIuZmlsdGVyLWJ0blwiKTtcclxuICAgIHZhciAkZmlsdGVyX3NoYWRvdyA9ICQoXCIuZmlsdGVyX19zaGFkb3dcIik7XHJcbiAgICB2YXIgJGZpbHRlcl93cmFwcGVyID0gJChcIi5maWx0ZXJfX3dyYXBwZXJcIik7XHJcbiAgICB2YXIgJGJhY2tkb29yID0gJChcIi5iYWNrZG9vclwiKTtcclxuICAgIHZhciAkZmlsdGVyX2lubmVyID0gJChcIi5maWx0ZXJfX2lubmVyXCIpO1xyXG4gICAgdmFyICRjYXRhbG9nID0gJChcIi5jYXRhbG9nXCIpO1xyXG4gICAgdmFyICRvcmRlciA9ICQoXCIub3JkZXJcIik7XHJcbiAgICB2YXIgdm1fc3dpcGUgPSAkKFwiLnZtLXN3aXBlLWlubmVyXCIpO1xyXG4gICAgdmFyICRmaWx0ZXJfaXRlbSA9ICQoXCIuZmlsdGVyX19pdGVtXCIpO1xyXG4gICAgdmFyICRmaWx0ZXJfbGluayA9ICQoXCIuZmlsdGVyX19pdGVtLWxpbmtcIik7XHJcblxyXG4gICAgc2V0X2ZpbHRlcl9zaXplKCk7XHJcbiAgICBcclxuICAgIHN2ZzRldmVyeWJvZHkoKTtcclxuXHJcbiAgICAkbWVudV9idG4ub24oXCJjbGlja1wiLCBvcGVuX21lbnUpO1xyXG4gICAgJGZpbHRlci5vbihcImNsaWNrXCIsIG9wZW5fZmlsdGVyKTtcclxuXHJcbiAgICAkYmFja2Rvb3Iub24oXCJjbGlja1wiLCBmdW5jdGlvbigpe1xyXG4gICAgICAgIGNsb3NlX21lbnUoKTtcclxuICAgICAgICBjbG9zZV9maWx0ZXIoKTtcclxuICAgIH0pO1xyXG5cclxuICAgICRmaWx0ZXJfbGluay5vbihcImNsaWNrXCIsIGZ1bmN0aW9uIChldmVudCkge1xyXG4gICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcblxyXG4gICAgICAgIGNsb3NlX2ZpbHRlcigpO1xyXG4gICAgICAgICRmaWx0ZXJfaXRlbS5yZW1vdmVDbGFzcyhcImZpbHRlcl9faXRlbS0tYWN0aXZlXCIpO1xyXG4gICAgICAgICQodGhpcykucGFyZW50KCkuYWRkQ2xhc3MoXCJmaWx0ZXJfX2l0ZW0tLWFjdGl2ZVwiKTtcclxuICAgICAgICBcclxuICAgICAgICB2YXIgZWxlbWVudENsaWNrID0gJCh0aGlzKS5hdHRyKFwiZGF0YS1zY3JvbGxcIik7XHJcbiAgICAgICAgdmFyIGRlc3RpbmF0aW9uID0gJChcIi5cIiArIGVsZW1lbnRDbGljaykub2Zmc2V0KCkudG9wO1xyXG4gICAgICAgIGpRdWVyeShcImh0bWw6bm90KDphbmltYXRlZCksYm9keTpub3QoOmFuaW1hdGVkKVwiKS5hbmltYXRlKHsgc2Nyb2xsVG9wOiBkZXN0aW5hdGlvbiB9LCA0MDApO1xyXG4gICAgfSk7XHJcblxyXG4gICAgJCh3aW5kb3cpLnJlc2l6ZShzZXRfZmlsdGVyX3NpemUpO1xyXG4gXHJcbiAgICAkKHdpbmRvdykucmVzaXplKGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIGlmICgkKHdpbmRvdykud2lkdGgoKSA8IDEwMjQpICQoXCIuc3dpcGVcIikudm1Td2lwZShcImRlc3Ryb3lcIik7ICAgIFxyXG4gICAgICAgIGlmICgkKHdpbmRvdykud2lkdGgoKSA+IDEwMjQpICQoXCIuc3dpcGVcIikudm1Td2lwZSh7ZGlyZWNpb246IFwiaG9yaXpvbnRhbFwifSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpZiAoJCh3aW5kb3cpLndpZHRoKCkgPiAxMDI0KSAkKFwiLnN3aXBlXCIpLnZtU3dpcGUoeyBkaXJlY2lvbjogXCJob3Jpem9udGFsXCIgfSk7XHJcblxyXG4gICAgZnVuY3Rpb24gb3Blbl9maWx0ZXIoKSB7XHJcbiAgICAgICAgJGZpbHRlcl93cmFwcGVyLmFkZENsYXNzKFwiZmlsdGVyX193cmFwcGVyLS1hY3RpdmVcIik7XHJcbiAgICAgICAgJGZpbHRlcl9zaGFkb3cucmVtb3ZlQ2xhc3MoXCJoaWRkZW5cIik7XHJcbiAgICAgICAgJGJhY2tkb29yLmFkZENsYXNzKFwiYWN0aXZlXCIpO1xyXG4gICAgICAgICRib2R5LnRvZ2dsZUNsYXNzKFwib3ZlcmZsb3ctaGlkZGVuXCIpO1xyXG4gICAgfVxyXG5cclxuICAgIGZ1bmN0aW9uIGNsb3NlX2ZpbHRlcigpIHtcclxuICAgICAgICAkZmlsdGVyX3dyYXBwZXIucmVtb3ZlQ2xhc3MoXCJmaWx0ZXJfX3dyYXBwZXItLWFjdGl2ZVwiKTtcclxuICAgICAgICAkZmlsdGVyX3NoYWRvdy5hZGRDbGFzcyhcImhpZGRlblwiKTtcclxuICAgICAgICAkYmFja2Rvb3IucmVtb3ZlQ2xhc3MoXCJhY3RpdmVcIik7XHJcbiAgICAgICAgJGJvZHkucmVtb3ZlQ2xhc3MoXCJvdmVyZmxvdy1oaWRkZW5cIik7XHJcbiAgICB9XHJcblxyXG4gICAgZnVuY3Rpb24gb3Blbl9tZW51KCkge1xyXG4gICAgICAgICRtZW51LmFkZENsYXNzKFwibmF2X193cmFwcGVyLS1hY3RpdmVcIik7XHJcbiAgICAgICAgJHNoYWRvdy5yZW1vdmVDbGFzcyhcImhpZGRlblwiKTtcclxuICAgICAgICAkYmFja2Rvb3IuYWRkQ2xhc3MoXCJhY3RpdmVcIik7XHJcbiAgICAgICAgJGJvZHkuYWRkQ2xhc3MoXCJvdmVyZmxvdy1oaWRkZW5cIik7XHJcbiAgICB9XHJcbiAgICBmdW5jdGlvbiBjbG9zZV9tZW51KCkge1xyXG4gICAgICAgICRtZW51LnJlbW92ZUNsYXNzKFwibmF2X193cmFwcGVyLS1hY3RpdmVcIik7XHJcbiAgICAgICAgJHNoYWRvdy5hZGRDbGFzcyhcImhpZGRlblwiKTtcclxuICAgICAgICAkYmFja2Rvb3IucmVtb3ZlQ2xhc3MoXCJhY3RpdmVcIik7XHJcbiAgICAgICAgJGJvZHkucmVtb3ZlQ2xhc3MoXCJvdmVyZmxvdy1oaWRkZW5cIik7XHJcbiAgICB9XHJcbiAgICBmdW5jdGlvbiBzZXRfZmlsdGVyX3NpemUoKSB7XHJcbiAgICAgICAgJGZpbHRlcl9zaGFkb3cud2lkdGgoJGJvZHkud2lkdGgoKSAtICRvcmRlci5vdXRlcldpZHRoKCkgLSAyMSk7XHJcbiAgICB9XHJcbn0pOyIsIlxuY29uc29sZS5sb2coXCJhc2RcIik7XG4oIGZ1bmN0aW9uKCAkICl7XG4gIC8vIENvbnN0YW50c1xuICB2YXIgJHZtX3N3aXBlID0gJChcIi52bS1zd2lwZVwiKTtcbiAgdmFyIFBMVUdJTl9OUyA9ICd2bVN3aXBlJyxcbiAgICAgIExFRlQgPSAnbGVmdCcsXG4gICAgICBSSUdIVCA9ICdyaWdodCcsXG4gICAgICBVUCA9ICd1cCcsXG4gICAgICBET1dOID0gJ2Rvd24nLFxuICBcbiAgICAgIE5PTkUgPSAnbm9uZSc7XG4gIFxuICB2YXIgZGVmYXVsdHMgPSB7XG4gICAgZGlyZWN0aW9uOiAnaG9yaXpvbnRhbCcsXG4gICAgaW5lcnRpYU1heFdpZHRoOiAxMDMwLFxuICAgIGluZXJ0aWFUaHJlc2hvbGQ6IDI1LFxuICAgIGFjdGl2ZUVsZW1lbnRzOiBbICdhJyBdXG4gIH07XG4gIFxuICAkLmZuLnZtU3dpcGUgPSBmdW5jdGlvbiggbWV0aG9kICl7XG4gICAgdmFyIGl0ID0gJCggdGhpcyApLFxuICAgICAgICBwbHVnaW4gPSBpdC5kYXRhKCBQTFVHSU5fTlMgKTtcbiAgICBcbiAgICBpZiAoIHBsdWdpbiAmJiB0eXBlb2YgbWV0aG9kID09PSAnc3RyaW5nJykge1xuICAgICAgaWYoIHBsdWdpblttZXRob2RdICkgcmV0dXJuIHBsdWdpblttZXRob2RdLmFwcGx5KCB0aGlzLCBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbCggYXJndW1lbnRzLCAxICkpO1xuICAgICAgZWxzZSAkLmVycm9yKCAn0JzQtdGC0L7QtCDRgSDQuNC80LXQvdC10LwgJyArICBtZXRob2QgKyAnINC90LUg0YHRg9GJ0LXRgdGC0LLRg9C10YIg0LTQu9GPIGpRdWVyeS52bVNsaWRlcicgKTtcbiAgICB9XG4gICAgZWxzZSBpZiAoIHBsdWdpbiAmJiB0eXBlb2YgbWV0aG9kID09PSAnb2JqZWN0JyApIHBsdWdpblsnb3B0aW9uJ10uYXBwbHkoIHBsdWdpbiwgYXJndW1lbnRzICk7XG4gICAgZWxzZSBpZiggdHlwZW9mIG1ldGhvZCA9PT0gJ29iamVjdCcgfHwgIW1ldGhvZCApIHJldHVybiBpbml0LmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTtcbiAgICBcbiAgICByZXR1cm4gaXQ7XG4gIH07XG4gIFxuICAkLmZuLnZtU3dpcGUuZGVmYXVsdHMgPSBkZWZhdWx0cztcbiAgXG4gIGZ1bmN0aW9uIGluaXQoIG9wdGlvbnMgKXtcbiAgICBpZiAoICFvcHRpb25zICkgb3B0aW9ucyA9IHt9O1xuICAgIG9wdGlvbnMgPSAkLmV4dGVuZCgge30sICQuZm4udm1Td2lwZS5kZWZhdWx0cywgb3B0aW9ucyApO1xuICAgIFxuICAgIHJldHVybiB0aGlzLmVhY2goIGZ1bmN0aW9uKCl7XG4gICAgICB2YXIgaXQgPSAkKCB0aGlzICk7XG4gICAgICBcbiAgICAgIHZhciBwbHVnaW4gPSBpdC5kYXRhKCBQTFVHSU5fTlMgKTtcbiAgICAgIFxuICAgICAgaWYgKCAhcGx1Z2luICkge1xuICAgICAgICBwbHVnaW4gPSBuZXcgVm1Td2lwZSggaXQsIG9wdGlvbnMgKTtcbiAgICAgICAgaXQuZGF0YSggUExVR0lOX05TLCBwbHVnaW4gKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuICBcbiAgZnVuY3Rpb24gVm1Td2lwZSggZWxlbWVudCwgb3B0aW9ucyApe1xuICAgIHZhciBvcHRpb25zID0gJC5leHRlbmQoIHt9LCBvcHRpb25zICk7XG4gICAgXG4gICAgdmFyIHN1cHBvcnRzID0ge1xuICAgICAgdHJhbnNpdGlvbjogbnVsbCxcbiAgICAgIGFuaW1hdGlvbjogbnVsbCxcbiAgICAgIHRyYW5zZm9ybTogbnVsbFxuICAgIH07XG4gICAgXG4gICAgdmFyIHBvc2l0aW9uID0ge1xuICAgICAgeDogMCxcbiAgICAgIHk6IDBcbiAgICB9O1xuICAgIFxuICAgIC8vIFRvdWNoIHByb3BlcnRpZXNcbiAgICB2YXIgZGlzdGFuY2UgPSAwLFxuICAgICAgICBjdXJyZW50RGlzdGFuY2UgPSBudWxsLFxuICAgICAgICBkaXJlY3Rpb24gPSBudWxsLFxuICAgICAgICBjdXJyZW50RGlyZWN0aW9uID0gbnVsbCxcbiAgICAgICAgZHVyYXRpb24gPSB7fSxcbiAgICAgICAgc3BlZWQgPSB7fTtcbiAgICBcbiAgICAvLyBGaW5nZXIgZGF0YSBvYmplY3RcbiAgICB2YXIgZmluZ2VyRGF0YSA9IHt9O1xuICAgIFxuICAgIC8vIERpcmVjdGlvbiBvZiBzd2lwZSAoaG9yaXpvbnRhbCwgdmVydGljYWwsIGJvdGgpXG4gICAgdmFyIHN3aXBlRGlyZWN0aW9uID0gb3B0aW9ucy5kaXJlY3Rpb247XG4gICAgXG4gICAgLy8gU3VwcG9ydCBjc3MgcHJvcGVydGllc1xuICAgIHN1cHBvcnQoIHN1cHBvcnRzICk7XG4gICAgXG4gICAgLy8gVHJhY2sgdGltZXNcbiAgICB2YXIgc3RhcnRUaW1lID0gMCxcbiAgICAgICAgZW5kVGltZSA9IDAsXG4gICAgICAgIGVuZE1vdmVUaW1lID0gMDtcbiAgXG4gICAgLy8gSW5lcnRpYSBtb2JpbGVcbiAgICB2YXIgd2l0aG91dEluZXJ0aWEsXG4gICAgICAgIHN0YXJ0VGltZU1vYmlsZTtcbiAgICBcbiAgICAvLyBBZGQgd3JhcHBlclxuICAgIHdyYXBDb250ZW50KCBlbGVtZW50ICk7XG4gICAgdmFyIGlubmVyV3JhcHBlciA9IGVsZW1lbnQuZmluZCggJy52bS1zd2lwZS1pbm5lcicgKTtcbiAgICBcbiAgICB0cnkge1xuICAgICAgZWxlbWVudC5vbiggJ3RvdWNoc3RhcnQudm1zd2lwZSBtb3VzZWRvd24udm1zd2lwZScsIHRvdWNoU3RhcnQgKTtcbiAgICAgIGVsZW1lbnQub24oICd0b3VjaGNhbmNlbC52bXN3aXBlJywgdG91Y2hFbmQgKTtcbiAgICB9XG4gICAgY2F0Y2goIGV2ZW50ICl7XG4gICAgICAkLmVycm9yKCAnZXZlbnRzIG5vdCBzdXBwb3J0ZWQgb24galF1ZXJ5LnN3aXBlJyApO1xuICAgIH1cbiAgICBcbiAgICAvLyBQdWJsaWMgbWV0aG9kc1xuICAgIHRoaXMuZGVzdHJveSA9IGZ1bmN0aW9uKCl7XG4gICAgICByZW1vdmVMaXN0ZW5lcnMoKTtcbiAgICAgIGVsZW1lbnQuZGF0YSggUExVR0lOX05TLCBudWxsICk7XG4gICAgICBpbm5lcldyYXBwZXIuY2hpbGRyZW4oKS51bndyYXAoKTtcbiAgICB9O1xuICAgIHRoaXMucmVmcmVzaCA9IGZ1bmN0aW9uKCl7XG4gICAgICBzd2l0Y2goIHN3aXBlRGlyZWN0aW9uICl7XG4gICAgICAgIGNhc2UgJ2hvcml6b250YWwnOlxuICAgICAgICAgIGlubmVyV3JhcHBlci53aWR0aCggZ2V0V3JhcHBlcldpZHRoKCBpbm5lcldyYXBwZXIgKSApO1xuICAgICAgICAgIHBvc2l0aW9uLnggPSBnZXRQb3NpdGlvbiggaW5uZXJXcmFwcGVyLm91dGVyV2lkdGgoKSwgZWxlbWVudC5vdXRlcldpZHRoKCksIHBvc2l0aW9uLnggKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgICBcbiAgICAgICAgY2FzZSAndmVydGljYWwnOlxuICAgICAgICAgIGlubmVyV3JhcHBlci5oZWlnaHQoIGdldFdyYXBwZXJIZWlnaHQoIGlubmVyV3JhcHBlciApICk7XG4gICAgICAgICAgcG9zaXRpb24ueSA9IGdldFBvc2l0aW9uKCBpbm5lcldyYXBwZXIub3V0ZXJIZWlnaHQoKSwgZWxlbWVudC5vdXRlckhlaWdodCgpLCBwb3NpdGlvbi55ICk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgXG4gICAgICAgIGNhc2UgJ2JvdGgnOlxuICAgICAgICAgIGlubmVyV3JhcHBlci53aWR0aCggZ2V0V3JhcHBlcldpZHRoKCBpbm5lcldyYXBwZXIgKSApO1xuICAgICAgICAgIGlubmVyV3JhcHBlci5oZWlnaHQoIGdldFdyYXBwZXJIZWlnaHQoIGlubmVyV3JhcHBlciApICk7XG4gICAgICAgICAgcG9zaXRpb24ueCA9IGdldFBvc2l0aW9uKCBpbm5lcldyYXBwZXIub3V0ZXJXaWR0aCgpLCBlbGVtZW50Lm91dGVyV2lkdGgoKSwgcG9zaXRpb24ueCApO1xuICAgICAgICAgIHBvc2l0aW9uLnkgPSBnZXRQb3NpdGlvbiggaW5uZXJXcmFwcGVyLm91dGVySGVpZ2h0KCksIGVsZW1lbnQub3V0ZXJIZWlnaHQoKSwgcG9zaXRpb24ueSApO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgfVxuICBcbiAgICAgIGlubmVyV3JhcHBlci5jc3MoeyAndHJhbnNmb3JtJzogJ3RyYW5zbGF0ZTNkKCcgKyBwb3NpdGlvbi54ICArICdweCwgJyArIHBvc2l0aW9uLnkgICsgJ3B4LCAwcHgpJyB9KTtcbiAgICB9O1xuICAgIFxuICAgIGZ1bmN0aW9uIHRvdWNoU3RhcnQoIGV2ZW50ICl7XG4gICAgICAvLyBDaGVjayBpZiB0aGlzIGVsZW1lbnQgbWF0Y2hlcyBhbnkgaW4gdGhlIGV4Y2x1ZGVkIGVsZW1lbnRzIHNlbGVjdG9ycywgb3IgaXRzIHBhcmVudCBpcyBleGNsdWRlZCwgaWYgc28sIERPTidUIHN3aXBlXG4gICAgICBpZiggaXNBY3RpdmVFbGVtZW50cyggJCggZXZlbnQudGFyZ2V0ICkgKSApIHJldHVybjtcbiAgXG4gICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgZXZlbnQgPSBldmVudC5vcmlnaW5hbEV2ZW50ID8gZXZlbnQub3JpZ2luYWxFdmVudCA6IGV2ZW50O1xuXG4gICAgICB2YXIgdG91Y2hlcyA9IGV2ZW50LnRvdWNoZXM7XG4gICAgICBldmVudCA9IHRvdWNoZXMgPyB0b3VjaGVzWzBdIDogZXZlbnQ7XG5cbiAgICAgIGRpc3RhbmNlID0gMDtcbiAgICAgIGN1cnJlbnREaXN0YW5jZSA9IDA7XG4gICAgICBkaXJlY3Rpb24gPSBudWxsO1xuICAgICAgY3VycmVudERpcmVjdGlvbiA9IG51bGw7XG4gICAgICBkdXJhdGlvbiA9IHt9O1xuICAgICAgc3RhcnRUaW1lID0gMDtcbiAgICAgIGVuZFRpbWUgPSAwO1xuICAgICAgc3BlZWQgPSB7fTtcbiAgICAgIHdpdGhvdXRJbmVydGlhID0gbnVsbDtcbiAgICAgIHN0YXJ0VGltZU1vYmlsZSA9IDA7XG5cbiAgICAgIGVsZW1lbnQudG9nZ2xlQ2xhc3MoICdtb3ZpbmcnLCBldmVudC50eXBlID09PSAnbW91c2Vkb3duJyk7XG5cbiAgICAgIGdldEN1cnJlbnRQb3NpdGlvbigpO1xuICAgICAgY3JlYXRlRmluZ2VyRGF0YSggZXZlbnQgKTtcblxuICAgICAgaW5uZXJXcmFwcGVyLnN0b3AoKTtcblxuICAgICAgJCggZG9jdW1lbnQgKS5vbiggJ3RvdWNoZW5kLnZtc3dpcGUgbW91c2V1cC52bXN3aXBlJywgJC5wcm94eSggdG91Y2hFbmQsIGVsZW1lbnQgKSApO1xuICAgICAgJCggZG9jdW1lbnQgKS5vbiggJ3RvdWNobW92ZS52bXN3aXBlIG1vdXNlbW92ZS52bXN3aXBlJywgJC5wcm94eSggdG91Y2hNb3ZlLCBlbGVtZW50ICkgKTtcbiAgICB9XG4gICAgZnVuY3Rpb24gdG91Y2hNb3ZlKCBldmVudCApe1xuICAgICAgZXZlbnQgPSBldmVudC5vcmlnaW5hbEV2ZW50ID8gZXZlbnQub3JpZ2luYWxFdmVudCA6IGV2ZW50O1xuICAgICAgXG4gICAgICB2YXIgdG91Y2hlcyA9IGV2ZW50LnRvdWNoZXM7XG4gICAgICBldmVudCA9IHRvdWNoZXMgPyB0b3VjaGVzWzBdIDogZXZlbnQ7XG4gICAgICBcbiAgICAgIHVwZGF0ZUZpbmdlckRhdGEoIGV2ZW50ICk7XG4gICAgICBzdGFydFN3aXBlVGltZSgpO1xuICAgICAgXG4gICAgICBlbmRUaW1lID0gZW5kTW92ZVRpbWUgPSBnZXRUaW1lU3RhbXAoKTtcbiAgICAgIGN1cnJlbnREaXJlY3Rpb24gPSBjYWxjdWxhdGVEaXJlY3Rpb24oIGZpbmdlckRhdGEubGFzdCwgZmluZ2VyRGF0YS5lbmQgKTtcbiAgICAgIGN1cnJlbnREaXN0YW5jZSA9IGNhbGN1bGF0ZUN1cnJlbnREaXN0YW5jZSggZmluZ2VyRGF0YS5lbmQsIGZpbmdlckRhdGEubGFzdCApO1xuICAgICAgZGlzdGFuY2UgPSBjYWxjdWxhdGVDdXJyZW50RGlzdGFuY2UoIGZpbmdlckRhdGEuZW5kLCBmaW5nZXJEYXRhLnN0YXJ0ICk7XG4gICAgICB3aXRob3V0SW5lcnRpYSA9IGlzUmVhbGx5RmluZ2VyTW92aW5nKCk7XG4gICAgICBcbiAgICAgIGNoYW5nZVBvc2l0aW9uKCBpbm5lcldyYXBwZXIsIGN1cnJlbnREaXJlY3Rpb24sIGN1cnJlbnREaXN0YW5jZSwgcG9zaXRpb24gKTtcbiAgICB9XG4gICAgZnVuY3Rpb24gdG91Y2hFbmQoKXtcbiAgICAgIGVuZFRpbWUgPSBnZXRUaW1lU3RhbXAoKTtcbiAgICAgIGR1cmF0aW9uID0gY2FsY3VsYXRlRHVyYXRpb24oKTtcbiAgICAgIHNwZWVkID0gY2FsY3VsYXRlU3BlZWQoIGRpc3RhbmNlLCBkdXJhdGlvbiApO1xuICBcbiAgICAgIGluZXJ0aWEoKTtcbiAgICAgIGVsZW1lbnQucmVtb3ZlQ2xhc3MoICdtb3ZpbmcnICk7XG4gICAgICBcbiAgICAgICQoIGRvY3VtZW50ICkub2ZmKCAndG91Y2htb3ZlLnZtc3dpcGUgbW91c2Vtb3ZlLnZtc3dpcGUnLCAkLnByb3h5KCB0b3VjaE1vdmUsIGVsZW1lbnQgKSApO1xuICAgICAgJCggZG9jdW1lbnQgKS5vZmYoICd0b3VjaGVuZC52bXN3aXBlIG1vdXNldXAudm1zd2lwZScsICQucHJveHkoIHRvdWNoRW5kLCBlbGVtZW50ICkgKTtcbiAgICB9XG4gICAgXG4gICAgd2luV2lkdGhSZXNpemUoIG51bGwsIGZ1bmN0aW9uKCl7XG4gICAgICBzd2l0Y2goIHN3aXBlRGlyZWN0aW9uICl7XG4gICAgICAgIGNhc2UgJ2hvcml6b250YWwnOlxuICAgICAgICAgIHBvc2l0aW9uLnggPSBnZXRQb3NpdGlvbiggaW5uZXJXcmFwcGVyLm91dGVyV2lkdGgoKSwgZWxlbWVudC5vdXRlcldpZHRoKCksIHBvc2l0aW9uLnggKTtcbiAgICAgICAgICBicmVhaztcbiAgICBcbiAgICAgICAgY2FzZSAndmVydGljYWwnOlxuICAgICAgICAgIHBvc2l0aW9uLnkgPSBnZXRQb3NpdGlvbiggaW5uZXJXcmFwcGVyLm91dGVySGVpZ2h0KCksIGVsZW1lbnQub3V0ZXJIZWlnaHQoKSwgcG9zaXRpb24ueSApO1xuICAgICAgICAgIGJyZWFrO1xuICAgIFxuICAgICAgICBjYXNlICdib3RoJzpcbiAgICAgICAgICBwb3NpdGlvbi54ID0gZ2V0UG9zaXRpb24oIGlubmVyV3JhcHBlci5vdXRlcldpZHRoKCksIGVsZW1lbnQub3V0ZXJXaWR0aCgpLCBwb3NpdGlvbi54ICk7XG4gICAgICAgICAgcG9zaXRpb24ueSA9IGdldFBvc2l0aW9uKCBpbm5lcldyYXBwZXIub3V0ZXJIZWlnaHQoKSwgZWxlbWVudC5vdXRlckhlaWdodCgpLCBwb3NpdGlvbi55ICk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gIFxuICAgICAgaW5uZXJXcmFwcGVyLmNzcyh7ICd0cmFuc2Zvcm0nOiAndHJhbnNsYXRlM2QoJyArIHBvc2l0aW9uLnggICsgJ3B4LCAnICsgcG9zaXRpb24ueSAgKyAncHgsIDBweCknIH0pO1xuICAgIH0pO1xuICAgIFxuICAgIFxuICAgIC8vIEhlbHBlcnNcbiAgICBmdW5jdGlvbiB3aW5XaWR0aFJlc2l6ZSggY29udGV4dCwgZnVuYyApe1xuICAgICAgdmFyIHRpbWVySWQsXG4gICAgICAgICAgd2luZG93V2lkdGggPSAkKCB3aW5kb3cgKS53aWR0aCgpLFxuICAgICAgICAgIGFyZyA9IFtdLnNsaWNlLmNhbGwoIGFyZ3VtZW50cywgMiApO1xuICAgICAgXG4gICAgICAkKCB3aW5kb3cgKS5yZXNpemUoIGZ1bmN0aW9uKCl7XG4gICAgICAgIGlmICggd2luZG93V2lkdGggPT09ICQoIHdpbmRvdyApLndpZHRoKCkgKSByZXR1cm47XG4gICAgICAgIGlmKCB0aW1lcklkICkgY2xlYXJUaW1lb3V0KCB0aW1lcklkICk7XG4gICAgICAgIFxuICAgICAgICB3aW5kb3dXaWR0aCA9ICQoIHdpbmRvdyApLndpZHRoKCk7XG4gICAgICAgIFxuICAgICAgICAvLyBUaGlzIGZ1bmN0aW9uIHdhcyBjYWxsZWQgb25jZSBhZnRlciByZXNpemUgZXZlbnRcbiAgICAgICAgdGltZXJJZCA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCl7XG4gICAgICAgICAgZnVuYy5hcHBseSggY29udGV4dCwgYXJnICk7XG4gICAgICAgICAgY2xlYXJUaW1lb3V0KCB0aW1lcklkICk7XG4gICAgICAgIH0sIDE1MCk7XG4gICAgICB9KTtcbiAgICB9XG4gICAgZnVuY3Rpb24gZ2V0Q3VycmVudFBvc2l0aW9uKCl7XG4gICAgICBpZiggc3VwcG9ydHMudHJhbnNmb3JtICl7XG4gICAgICAgIHBvc2l0aW9uID0gaW5uZXJXcmFwcGVyLmNzcyggJ3RyYW5zZm9ybScgKS5yZXBsYWNlKCAvLipcXCh8XFwpfCAvZywgJycgKS5zcGxpdCggJywnICk7XG4gICAgICAgIHBvc2l0aW9uID0ge1xuICAgICAgICAgIHg6ICtwb3NpdGlvbltwb3NpdGlvbi5sZW5ndGggPT09IDE2ID8gMTIgOiA0XSxcbiAgICAgICAgICB5OiArcG9zaXRpb25bcG9zaXRpb24ubGVuZ3RoID09PSAxNiA/IDEzIDogNV1cbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICAgIGVsc2V7XG4gICAgICAgIHBvc2l0aW9uID0gaW5uZXJXcmFwcGVyLnBvc2l0aW9uKCk7XG4gICAgICAgIHBvc2l0aW9uID0ge1xuICAgICAgICAgIHg6ICtwb3NpdGlvbi5sZWZ0LFxuICAgICAgICAgIHk6ICtwb3NpdGlvbi50b3BcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICB9XG4gICAgZnVuY3Rpb24gd3JhcENvbnRlbnQoIGVsZW1lbnQgKXtcbiAgICAgIGVsZW1lbnQuY29udGVudHMoKS53cmFwQWxsKCBjcmVhdGVXcmFwcGVyKCkgKTtcbiAgICB9XG4gICAgZnVuY3Rpb24gY3JlYXRlV3JhcHBlcigpe1xuICAgICAgdmFyIHdyYXBwZXIgPSAkKCAnPGRpdiAvPicse1xuICAgICAgICAnY2xhc3MnOiAndm0tc3dpcGUtaW5uZXInXG4gICAgICB9KTtcbiAgICAgIHdyYXBwZXIuY3NzKHtcbiAgICAgICAgJ3dpZHRoJzogKCBvcHRpb25zLmRpcmVjdGlvbiA9PT0gJ2hvcml6b250YWwnIHx8IG9wdGlvbnMuZGlyZWN0aW9uID09PSAnYm90aCcgKSA/IGdldFdyYXBwZXJXaWR0aCggZWxlbWVudCApIDogJycsXG4gICAgICAgICdoZWlnaHQnOiAoIG9wdGlvbnMuZGlyZWN0aW9uID09PSAndmVydGljYWwnIHx8IG9wdGlvbnMuZGlyZWN0aW9uID09PSAnYm90aCcgKSA/IGdldFdyYXBwZXJIZWlnaHQoIGVsZW1lbnQgKSA6ICcnLFxuICAgICAgICAndHJhbnNmb3JtJzogJ3RyYW5zbGF0ZTNkKDBweCwgMHB4LCAwcHgpJ1xuICAgICAgXG4gICAgICB9KTtcbiAgICAgIHJldHVybiB3cmFwcGVyO1xuICAgIH1cbiAgICBmdW5jdGlvbiBnZXRXcmFwcGVyV2lkdGgoIGVsZW1lbnQgKXtcbiAgICAgIHZhciB3aWR0aCA9IDA7XG4gICAgXG4gICAgICBlbGVtZW50LmZpbmQoJHZtX3N3aXBlKS5jaGlsZHJlbigpLmVhY2goIGZ1bmN0aW9uKCl7XG4gICAgICAgIHZhciBpdCA9ICQoIHRoaXMgKTtcbiAgICAgICAgd2lkdGggKz0gaXQub3V0ZXJXaWR0aCggdHJ1ZSApO1xuICAgICAgfSk7XG4gICAgICByZXR1cm4gd2lkdGggKyAxMjA7XG4gICAgfVxuICAgIGZ1bmN0aW9uIGdldFdyYXBwZXJIZWlnaHQoIGVsZW1lbnQgKXtcbiAgICAgIHZhciBoZWlnaHQgPSAwO1xuICAgIFxuICAgICAgZWxlbWVudC5jaGlsZHJlbigpLmVhY2goIGZ1bmN0aW9uKCl7XG4gICAgICAgIHZhciBpdCA9ICQoIHRoaXMgKTtcbiAgICAgICAgaGVpZ2h0ICs9IGl0Lm91dGVySGVpZ2h0KCB0cnVlICk7XG4gICAgICB9KTtcbiAgICBcbiAgICAgIHJldHVybiBoZWlnaHQ7XG4gICAgfVxuICAgIGZ1bmN0aW9uIGNyZWF0ZUZpbmdlckRhdGEoIGV2ZW50ICkge1xuICAgICAgdmFyIGYgPSB7XG4gICAgICAgIHN0YXJ0OiB7XG4gICAgICAgICAgeDogMCxcbiAgICAgICAgICB5OiAwXG4gICAgICAgIH0sXG4gICAgICAgIGxhc3Q6IHtcbiAgICAgICAgICB4OiAwLFxuICAgICAgICAgIHk6IDBcbiAgICAgICAgfSxcbiAgICAgICAgZW5kOiB7XG4gICAgICAgICAgeDogMCxcbiAgICAgICAgICB5OiAwXG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgICBmLnN0YXJ0LnggPSBmLmxhc3QueCA9IGYuZW5kLnggPSBldmVudC5wYWdlWCB8fCBldmVudC5jbGllbnRYO1xuICAgICAgZi5zdGFydC55ID0gZi5sYXN0LnkgPSBmLmVuZC55ID0gZXZlbnQucGFnZVkgfHwgZXZlbnQuY2xpZW50WTtcbiAgICAgIGZpbmdlckRhdGEgPSBmO1xuICAgICAgcmV0dXJuIGY7XG4gICAgfVxuICAgIGZ1bmN0aW9uIHVwZGF0ZUZpbmdlckRhdGEoIGV2ZW50ICl7XG4gICAgICBpZiAoICFPYmplY3Qua2V5cyggZmluZ2VyRGF0YSApLmxlbmd0aCApIGNyZWF0ZUZpbmdlckRhdGEoIGV2ZW50ICk7XG4gICAgICBcbiAgICAgIGZpbmdlckRhdGEubGFzdC54ID0gZmluZ2VyRGF0YS5lbmQueDtcbiAgICAgIGZpbmdlckRhdGEubGFzdC55ID0gZmluZ2VyRGF0YS5lbmQueTtcbiAgICAgIFxuICAgICAgZmluZ2VyRGF0YS5lbmQueCA9IGV2ZW50LnBhZ2VYIHx8IGV2ZW50LmNsaWVudFg7XG4gICAgICBmaW5nZXJEYXRhLmVuZC55ID0gZXZlbnQucGFnZVkgfHwgZXZlbnQuY2xpZW50WTtcbiAgICAgIFxuICAgICAgcmV0dXJuIGZpbmdlckRhdGE7XG4gICAgfVxuICAgIGZ1bmN0aW9uIGNoYW5nZVBvc2l0aW9uKCBpbm5lcldyYXBwZXIsIGN1cnJlbnREaXJlY3Rpb24sIGN1cnJlbnREaXN0YW5jZSwgcG9zaXRpb24gKXtcbiAgICAgIHN3aXRjaCggc3dpcGVEaXJlY3Rpb24gKXtcbiAgICAgICAgY2FzZSAnaG9yaXpvbnRhbCc6XG4gICAgICAgICAgaWYoIGN1cnJlbnREaXJlY3Rpb24gPT09ICd1cCcgfHwgY3VycmVudERpcmVjdGlvbiA9PT0gJ2Rvd24nICkgcmV0dXJuO1xuICAgICAgICAgIHBvc2l0aW9uLnggKz0gY3VycmVudERpc3RhbmNlLng7XG4gICAgICAgICAgcG9zaXRpb24ueCA9IGdldFBvc2l0aW9uKCBpbm5lcldyYXBwZXIub3V0ZXJXaWR0aCgpLCBlbGVtZW50Lm91dGVyV2lkdGgoKSwgcG9zaXRpb24ueCApO1xuICAgICAgICAgIGJyZWFrO1xuICBcbiAgICAgICAgY2FzZSAndmVydGljYWwnOlxuICAgICAgICAgIGlmKCBjdXJyZW50RGlyZWN0aW9uID09PSAnbGVmdCcgfHwgY3VycmVudERpcmVjdGlvbiA9PT0gJ3JpZ2h0JyApIHJldHVybjtcbiAgICAgICAgICBwb3NpdGlvbi55ICs9IGN1cnJlbnREaXN0YW5jZS55O1xuICAgICAgICAgIHBvc2l0aW9uLnkgPSBnZXRQb3NpdGlvbiggaW5uZXJXcmFwcGVyLm91dGVySGVpZ2h0KCksIGVsZW1lbnQub3V0ZXJIZWlnaHQoKSwgcG9zaXRpb24ueSApO1xuICAgICAgICAgIGJyZWFrO1xuICBcbiAgICAgICAgY2FzZSAnYm90aCc6XG4gICAgICAgICAgcG9zaXRpb24ueCArPSBjdXJyZW50RGlzdGFuY2UueDtcbiAgICAgICAgICBwb3NpdGlvbi55ICs9IGN1cnJlbnREaXN0YW5jZS55O1xuICAgICAgICAgIHBvc2l0aW9uLnggPSBnZXRQb3NpdGlvbiggaW5uZXJXcmFwcGVyLm91dGVyV2lkdGgoKSwgZWxlbWVudC5vdXRlcldpZHRoKCksIHBvc2l0aW9uLnggKTtcbiAgICAgICAgICBwb3NpdGlvbi55ID0gZ2V0UG9zaXRpb24oIGlubmVyV3JhcHBlci5vdXRlckhlaWdodCgpLCBlbGVtZW50Lm91dGVySGVpZ2h0KCksIHBvc2l0aW9uLnkgKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIFxuICAgICAgaW5uZXJXcmFwcGVyLmNzcyh7ICd0cmFuc2Zvcm0nOiAndHJhbnNsYXRlM2QoJyArIHBvc2l0aW9uLnggKyAncHgsICcgKyBwb3NpdGlvbi55ICsgJ3B4LCAwcHgpJyB9KTtcbiAgICB9XG4gICAgZnVuY3Rpb24gZ2V0UG9zaXRpb24oIHdyYXBwZXJEaW1lbnNpb25zLCBlbGVtZW50RGltZW50aW9ucywgcG9zaXRpb24gKXtcbiAgICAgIGlmKCB3cmFwcGVyRGltZW5zaW9ucyA8PSBlbGVtZW50RGltZW50aW9ucyApIHJldHVybiAwO1xuICAgICAgaWYoIHBvc2l0aW9uID4gMCApIHBvc2l0aW9uID0gMDtcbiAgICAgIGlmKCBNYXRoLmFicyggcG9zaXRpb24gKSA+ICggd3JhcHBlckRpbWVuc2lvbnMgLSBlbGVtZW50RGltZW50aW9ucyApICkgcG9zaXRpb24gPSAtKCB3cmFwcGVyRGltZW5zaW9ucyAtIGVsZW1lbnREaW1lbnRpb25zICk7XG4gICAgICByZXR1cm4gcG9zaXRpb247XG4gICAgfVxuICAgIGZ1bmN0aW9uIHN1cHBvcnQoIHZhbHVlcyApe1xuICAgICAgdmFyIHN0eWxlcyA9ICQoICc8c3VwcG9ydCAvPicgKS5nZXQoIDAgKS5zdHlsZTtcbiAgICAgICQuZWFjaCggdmFsdWVzLCBmdW5jdGlvbigga2V5LCB2YWx1ZSApe1xuICAgICAgICBpZiggc3R5bGVzW2tleV0gIT09IHVuZGVmaW5lZCApIHZhbHVlc1trZXldID0gdHJ1ZTtcbiAgICAgIH0pO1xuICAgIH1cbiAgICBmdW5jdGlvbiBnZXRUaW1lU3RhbXAoKSB7XG4gICAgICByZXR1cm4gbmV3IERhdGUoKS5nZXRUaW1lKCk7XG4gICAgfVxuICAgIGZ1bmN0aW9uIGNhbGN1bGF0ZURpcmVjdGlvbiggc3RhcnRQb2ludCwgZW5kUG9pbnQgKXtcbiAgICAgIGlmKCBjb21wYXJlUG9pbnRzKCBzdGFydFBvaW50LCBlbmRQb2ludCApICkgcmV0dXJuIE5PTkU7XG4gICAgICBcbiAgICAgIHZhciBhbmdsZSA9IGNhbGN1bGF0ZUFuZ2xlKCBzdGFydFBvaW50LCBlbmRQb2ludCApO1xuICAgICAgXG4gICAgICBpZiggKCBhbmdsZSA8PSA0NSApICYmICggYW5nbGUgPj0gMCApICkgcmV0dXJuIExFRlQ7XG4gICAgICBlbHNlIGlmKCAoIGFuZ2xlIDw9IDM2MCApICYmICggYW5nbGUgPj0gMzE1ICkgKSByZXR1cm4gTEVGVDtcbiAgICAgIGVsc2UgaWYoICggYW5nbGUgPj0gMTM1ICkgJiYgKCBhbmdsZSA8PSAyMjUgKSApIHJldHVybiBSSUdIVDtcbiAgICAgIGVsc2UgaWYoICggYW5nbGUgPiA0NSApICYmICggYW5nbGUgPCAxMzUgKSApIHJldHVybiBET1dOO1xuICAgICAgZWxzZSByZXR1cm4gVVA7XG4gICAgfVxuICAgIGZ1bmN0aW9uIGNvbXBhcmVQb2ludHMoIHBvaW50QSwgcG9pbnRCICl7XG4gICAgICByZXR1cm4gKCBwb2ludEEueCA9PT0gcG9pbnRCLnggJiYgcG9pbnRBLnkgPT09IHBvaW50Qi55ICk7XG4gICAgfVxuICAgIGZ1bmN0aW9uIGNhbGN1bGF0ZUFuZ2xlKCBzdGFydFBvaW50LCBlbmRQb2ludCApe1xuICAgICAgdmFyIHggPSBzdGFydFBvaW50LnggLSBlbmRQb2ludC54LFxuICAgICAgICAgIHkgPSBlbmRQb2ludC55IC0gc3RhcnRQb2ludC55LFxuICAgICAgICAgIHIgPSBNYXRoLmF0YW4yKCB5LCB4ICksIC8vcmFkaWFuc1xuICAgICAgICAgIGFuZ2xlID0gTWF0aC5yb3VuZCggciAqIDE4MCAvIE1hdGguUEkgKTsgLy9kZWdyZWVzXG4gICAgICBcbiAgICAgIC8vZW5zdXJlIHZhbHVlIGlzIHBvc2l0aXZlXG4gICAgICBpZiggYW5nbGUgPCAwICkgYW5nbGUgPSAzNjAgLSBNYXRoLmFicyhhbmdsZSk7XG4gICAgICBcbiAgICAgIHJldHVybiBhbmdsZTtcbiAgICB9XG4gICAgZnVuY3Rpb24gY2FsY3VsYXRlQ3VycmVudERpc3RhbmNlKCBzdGFydFBvaW50LCBlbmRQb2ludCApe1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgeDogc3RhcnRQb2ludC54IC0gZW5kUG9pbnQueCxcbiAgICAgICAgeTogc3RhcnRQb2ludC55IC0gZW5kUG9pbnQueVxuICAgICAgfVxuICAgIH1cbiAgICBmdW5jdGlvbiBjYWxjdWxhdGVTcGVlZCggZGlzdGFuY2UsIHRpbWUgKXtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHg6IGRpc3RhbmNlLnggLyB0aW1lLFxuICAgICAgICB5OiBkaXN0YW5jZS55IC8gdGltZVxuICAgICAgfVxuICAgIH1cbiAgICBmdW5jdGlvbiBjYWxjdWxhdGVEdXJhdGlvbigpIHtcbiAgICAgIHZhciBkdXJhdGlvbjtcbiAgICAgIGlmKCAhc3RhcnRUaW1lICkgZHVyYXRpb24gPSAwO1xuICAgICAgZWxzZSBkdXJhdGlvbiA9IGVuZFRpbWUgLSBzdGFydFRpbWU7XG4gICAgICByZXR1cm4gZHVyYXRpb247XG4gICAgfVxuICAgIGZ1bmN0aW9uIHJlbW92ZUxpc3RlbmVycygpe1xuICAgICAgJCggZG9jdW1lbnQgKS5vZmYoICcudm1zd2lwZScgKTtcbiAgICAgIGVsZW1lbnQub2ZmKCAnLnZtc3dpcGUnICk7XG4gICAgfVxuICAgIGZ1bmN0aW9uIHN0YXJ0U3dpcGVUaW1lKCl7XG4gICAgICBpZiggZW5kVGltZSApcmV0dXJuO1xuICAgICAgc3RhcnRUaW1lID0gZ2V0VGltZVN0YW1wKCk7XG4gICAgfVxuICAgIGZ1bmN0aW9uIGlzUmVhbGx5RmluZ2VyTW92aW5nKCl7XG4gICAgICB2YXIgY3VycmVudFRpbWVNb2JpbGUgPSBnZXRUaW1lU3RhbXAoKSxcbiAgICAgICAgICBhYnNEaXN0YW5jZSxcbiAgICAgICAgICBkZWx0YVRpbWU7XG4gICAgXG4gICAgICBpZiggIXN0YXJ0VGltZU1vYmlsZSApIHN0YXJ0VGltZU1vYmlsZSA9IGN1cnJlbnRUaW1lTW9iaWxlO1xuICBcbiAgICAgIHN3aXRjaCggc3dpcGVEaXJlY3Rpb24gKXtcbiAgICAgICAgY2FzZSAnaG9yaXpvbnRhbCc6XG4gICAgICAgICAgYWJzRGlzdGFuY2UgPSBNYXRoLmFicyggZmluZ2VyRGF0YS5lbmQueCAtIGZpbmdlckRhdGEubGFzdC54ICk7XG4gICAgICAgICAgYnJlYWs7XG4gIFxuICAgICAgICBjYXNlICd2ZXJ0aWNhbCc6XG4gICAgICAgICAgYWJzRGlzdGFuY2UgPSBNYXRoLmFicyggZmluZ2VyRGF0YS5lbmQueSAtIGZpbmdlckRhdGEubGFzdC55ICk7XG4gICAgICAgICAgYnJlYWs7XG4gIFxuICAgICAgICBjYXNlICdib3RoJzpcbiAgICAgICAgICBhYnNEaXN0YW5jZSA9IE1hdGgubWF4KCBNYXRoLmFicyggZmluZ2VyRGF0YS5lbmQueCAtIGZpbmdlckRhdGEubGFzdC54ICksIE1hdGguYWJzKCBmaW5nZXJEYXRhLmVuZC55IC0gZmluZ2VyRGF0YS5sYXN0LnkgKSApO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgXG4gICAgICBkZWx0YVRpbWUgPSBjdXJyZW50VGltZU1vYmlsZSAtIHN0YXJ0VGltZU1vYmlsZTtcbiAgICAgIHJldHVybiAoIGFic0Rpc3RhbmNlIDwgMTAgKSAmJiAoIGRlbHRhVGltZSA+IDEwMCApO1xuICAgIH1cbiAgICBmdW5jdGlvbiBpbmVydGlhKCl7XG4gICAgICB2YXIgYWJzRGlzdGFuY2U7XG4gICAgXG4gICAgICBzd2l0Y2goIHN3aXBlRGlyZWN0aW9uICl7XG4gICAgICAgIGNhc2UgJ2hvcml6b250YWwnOlxuICAgICAgICAgIGFic0Rpc3RhbmNlID0gTWF0aC5hYnMoIGRpc3RhbmNlLnggKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgIFxuICAgICAgICBjYXNlICd2ZXJ0aWNhbCc6XG4gICAgICAgICAgYWJzRGlzdGFuY2UgPSBNYXRoLmFicyggZGlzdGFuY2UueSApO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgXG4gICAgICAgIGNhc2UgJ2JvdGgnOlxuICAgICAgICAgIGFic0Rpc3RhbmNlID0gTWF0aC5tYXgoIE1hdGguYWJzKCBkaXN0YW5jZS54ICksIE1hdGguYWJzKCBkaXN0YW5jZS55ICkgKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIFxuICAgICAgdmFyIGlzVGltZUZvckluZXJ0aWEgPSAoIGVuZFRpbWUgLSBlbmRNb3ZlVGltZSApIDwgNTA7XG4gICAgICB2YXIgaXNXaWR0aEZvckluZXJ0aWEgPSAkKCB3aW5kb3cgKS53aWR0aCgpIDw9IG9wdGlvbnMuaW5lcnRpYU1heFdpZHRoO1xuICAgICAgdmFyIGlzRGlzdGFuY2VGb3JJbmVydGlhID0gYWJzRGlzdGFuY2UgPiBvcHRpb25zLmluZXJ0aWFUaHJlc2hvbGQ7XG4gICAgXG4gICAgICBpZiggKCBpc1RpbWVGb3JJbmVydGlhICYmICF3aXRob3V0SW5lcnRpYSApICYmIGlzV2lkdGhGb3JJbmVydGlhICYmIGlzRGlzdGFuY2VGb3JJbmVydGlhICkgZ2V0SW5lcnRpYSgpO1xuICAgIH1cbiAgICBmdW5jdGlvbiBnZXRJbmVydGlhKCl7XG4gICAgICBpbm5lcldyYXBwZXIuY3NzKHsndGV4dC1pbmRlbnQnOiAxMDB9KTtcbiAgICAgIGlubmVyV3JhcHBlci5hbmltYXRlKHtcbiAgICAgICAgdGV4dEluZGVudDogMFxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgZHVyYXRpb246ICggTWF0aC5tYXgoIE1hdGguYWJzKCBzcGVlZC54ICksIE1hdGguYWJzKCBzcGVlZC55ICkgKSAqIDUwMDAgKSxcbiAgICAgICAgc3RlcDogZnVuY3Rpb24oIGN1cnJlbnRTdGVwICl7XG4gICAgICAgICAgdmFyIHRoaXNTdGVwVGltZSA9IGdldFRpbWVTdGFtcCgpLFxuICAgICAgICAgICAgICBzdGVwRHVyYXRpb24gPSB0aGlzU3RlcFRpbWUgLSBlbmRUaW1lO1xuICAgICAgICAgIFxuICAgICAgICAgIGVuZFRpbWUgPSB0aGlzU3RlcFRpbWU7XG4gICAgICAgICAgc3BlZWQueCAqPSBjdXJyZW50U3RlcCAvIDEwMDtcbiAgICAgICAgICBzcGVlZC55ICo9IGN1cnJlbnRTdGVwIC8gMTAwO1xuICBcbiAgICAgICAgICBjdXJyZW50RGlzdGFuY2UueCA9IHNwZWVkLnggKiBzdGVwRHVyYXRpb247XG4gICAgICAgICAgY3VycmVudERpc3RhbmNlLnkgPSBzcGVlZC55ICogc3RlcER1cmF0aW9uO1xuICAgIFxuICAgICAgICAgIGNoYW5nZVBvc2l0aW9uKCBpbm5lcldyYXBwZXIsIGN1cnJlbnREaXJlY3Rpb24sIGN1cnJlbnREaXN0YW5jZSwgcG9zaXRpb24gKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICAgIGZ1bmN0aW9uIGlzQWN0aXZlRWxlbWVudHMoIGVsZW1lbnQgKXtcbiAgICAgIGZvciggdmFyIGkgPSAwLCBsID0gb3B0aW9ucy5hY3RpdmVFbGVtZW50cy5sZW5ndGg7IGkgPCBsOyBpKysgKXtcbiAgICAgICAgaWYoIGVsZW1lbnQuY2xvc2VzdCggb3B0aW9ucy5hY3RpdmVFbGVtZW50c1tpXSwgaW5uZXJXcmFwcGVyICkubGVuZ3RoICkgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGZ1bmN0aW9uIGNhbGN1bGF0ZURpc3RhbmNlKCBzdGFydFBvaW50LCBlbmRQb2ludCApe1xuICAgICAgcmV0dXJuIE1hdGgucm91bmQoIE1hdGguc3FydCggTWF0aC5wb3coIGVuZFBvaW50LnggLSBzdGFydFBvaW50LngsIDIgKSArIE1hdGgucG93KCBlbmRQb2ludC55IC0gc3RhcnRQb2ludC55LCAyICkgKSApO1xuICAgIH1cbiAgfVxuICBcbn0pKCBqUXVlcnkgKTsiLCIkKGRvY3VtZW50KS5yZWFkeShmdW5jdGlvbigpe1xyXG4gICAgdmFyICRib2R5ID0gJChcImJvZHlcIik7XHJcbiAgICB2YXIgJHBvcHVwX29wZW5fYnRuID0gJChcIi5jYXRhbG9nX19pdGVtLW1vcmVcIik7XHJcbiAgICB2YXIgJGNhdGFsb2dfaW1hZ2UgPSAkKFwiLmNhdGFsb2dfX2ltYWdlXCIpO1xyXG4gICAgdmFyICRwb3B1cF9jbG9zZV9idG4gPSAkKFwiLnBvcHVwX19jbG9zZVwiKTtcclxuICAgIHZhciAkaGVhZGVyID0gJChcIi5oZWFkZXJcIik7IFxyXG4gICAgdmFyICRtYWluID0gJChcIi5tYWluXCIpOyBcclxuICAgIHZhciAkcG9wdXAgPSAkKFwiLnBvcHVwXCIpO1xyXG4gICAgdmFyICRiYWNrZG9vciA9ICQoXCIuYmFja2Rvb3JcIik7XHJcblxyXG4gICAgJGJhY2tkb29yLm9uKFwiY2xpY2tcIiwgZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgYmFja2Rvb3JfYmx1cl9vZmYoKTtcclxuICAgICAgICBiYWNrZG9vcl9vZmYoKTtcclxuICAgICAgICBjbG9zZV9wb3B1cCgpO1xyXG4gICAgfSk7XHJcbiAgICAkY2F0YWxvZ19pbWFnZS5vbihcImNsaWNrXCIsIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAkYm9keS5hZGRDbGFzcyhcIm92ZXJmbG93LWhpZGRlbiBwYWRkaW5nLXNjcm9sbFwiKTtcclxuICAgICAgICBiYWNrZG9vcl9vbigpO1xyXG4gICAgICAgIGJhY2tkb29yX2JsdXJfb24oKTtcclxuICAgICAgICBvcGVuX3BvcHVwKCk7XHJcbiAgICB9KTtcclxuICAgICRwb3B1cF9vcGVuX2J0bi5vbihcImNsaWNrXCIsIGZ1bmN0aW9uKCl7XHJcbiAgICAgICAgJGJvZHkuYWRkQ2xhc3MoXCJvdmVyZmxvdy1oaWRkZW4gcGFkZGluZy1zY3JvbGxcIik7XHJcbiAgICAgICAgYmFja2Rvb3Jfb24oKTtcclxuICAgICAgICBiYWNrZG9vcl9ibHVyX29uKCk7XHJcbiAgICAgICAgb3Blbl9wb3B1cCgpO1xyXG4gICAgfSk7XHJcbiAgICAkcG9wdXBfY2xvc2VfYnRuLm9uKFwiY2xpY2tcIiwgZnVuY3Rpb24oKXtcclxuICAgICAgICAkYm9keS5yZW1vdmVDbGFzcyhcIm92ZXJmbG93LWhpZGRlbiBwYWRkaW5nLXNjcm9sbFwiKTtcclxuICAgICAgICBiYWNrZG9vcl9vZmYoKTtcclxuICAgICAgICBiYWNrZG9vcl9ibHVyX29mZigpO1xyXG4gICAgICAgIGNsb3NlX3BvcHVwKCk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBmdW5jdGlvbiBiYWNrZG9vcl9vbigpIHtcclxuICAgICAgICAkYmFja2Rvb3IuYWRkQ2xhc3MoXCJhY3RpdmVcIik7XHJcbiAgICB9XHJcbiAgICBmdW5jdGlvbiBiYWNrZG9vcl9vZmYoKSB7XHJcbiAgICAgICAgJGJhY2tkb29yLnJlbW92ZUNsYXNzKFwiYWN0aXZlXCIpO1xyXG4gICAgfVxyXG4gICAgZnVuY3Rpb24gYmFja2Rvb3JfYmx1cl9vbigpIHtcclxuICAgICAgICAkaGVhZGVyLmFkZENsYXNzKFwiZmlsdGVyLWJsdXJcIik7XHJcbiAgICAgICAgJG1haW4uYWRkQ2xhc3MoXCJmaWx0ZXItYmx1clwiKTtcclxuICAgIH1cclxuICAgIGZ1bmN0aW9uIGJhY2tkb29yX2JsdXJfb2ZmKCkge1xyXG4gICAgICAgICRoZWFkZXIucmVtb3ZlQ2xhc3MoXCJmaWx0ZXItYmx1clwiKTtcclxuICAgICAgICAkbWFpbi5yZW1vdmVDbGFzcyhcImZpbHRlci1ibHVyXCIpO1xyXG4gICAgfVxyXG4gICAgZnVuY3Rpb24gb3Blbl9wb3B1cCgpIHtcclxuICAgICAgICAkcG9wdXAuYWRkQ2xhc3MoXCJwb3B1cC0tYWN0aXZlXCIpO1xyXG4gICAgfVxyXG4gICAgZnVuY3Rpb24gY2xvc2VfcG9wdXAoKSB7XHJcbiAgICAgICAgJHBvcHVwLnJlbW92ZUNsYXNzKFwicG9wdXAtLWFjdGl2ZVwiKTtcclxuICAgIH1cclxufSk7IiwiIWZ1bmN0aW9uIChyb290LCBmYWN0b3J5KSB7XHJcbiAgICBcImZ1bmN0aW9uXCIgPT0gdHlwZW9mIGRlZmluZSAmJiBkZWZpbmUuYW1kID8gLy8gQU1ELiBSZWdpc3RlciBhcyBhbiBhbm9ueW1vdXMgbW9kdWxlIHVubGVzcyBhbWRNb2R1bGVJZCBpcyBzZXRcclxuICAgICAgICBkZWZpbmUoW10sIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHJvb3Quc3ZnNGV2ZXJ5Ym9keSA9IGZhY3RvcnkoKTtcclxuICAgICAgICB9KSA6IFwib2JqZWN0XCIgPT0gdHlwZW9mIG1vZHVsZSAmJiBtb2R1bGUuZXhwb3J0cyA/IC8vIE5vZGUuIERvZXMgbm90IHdvcmsgd2l0aCBzdHJpY3QgQ29tbW9uSlMsIGJ1dFxyXG4gICAgICAgICAgICAvLyBvbmx5IENvbW1vbkpTLWxpa2UgZW52aXJvbm1lbnRzIHRoYXQgc3VwcG9ydCBtb2R1bGUuZXhwb3J0cyxcclxuICAgICAgICAgICAgLy8gbGlrZSBOb2RlLlxyXG4gICAgICAgICAgICBtb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkoKSA6IHJvb3Quc3ZnNGV2ZXJ5Ym9keSA9IGZhY3RvcnkoKTtcclxufSh0aGlzLCBmdW5jdGlvbiAoKSB7XHJcbiAgICAvKiEgc3ZnNGV2ZXJ5Ym9keSB2Mi4xLjkgfCBnaXRodWIuY29tL2pvbmF0aGFudG5lYWwvc3ZnNGV2ZXJ5Ym9keSAqL1xyXG4gICAgZnVuY3Rpb24gZW1iZWQocGFyZW50LCBzdmcsIHRhcmdldCkge1xyXG4gICAgICAgIC8vIGlmIHRoZSB0YXJnZXQgZXhpc3RzXHJcbiAgICAgICAgaWYgKHRhcmdldCkge1xyXG4gICAgICAgICAgICAvLyBjcmVhdGUgYSBkb2N1bWVudCBmcmFnbWVudCB0byBob2xkIHRoZSBjb250ZW50cyBvZiB0aGUgdGFyZ2V0XHJcbiAgICAgICAgICAgIHZhciBmcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKSwgdmlld0JveCA9ICFzdmcuaGFzQXR0cmlidXRlKFwidmlld0JveFwiKSAmJiB0YXJnZXQuZ2V0QXR0cmlidXRlKFwidmlld0JveFwiKTtcclxuICAgICAgICAgICAgLy8gY29uZGl0aW9uYWxseSBzZXQgdGhlIHZpZXdCb3ggb24gdGhlIHN2Z1xyXG4gICAgICAgICAgICB2aWV3Qm94ICYmIHN2Zy5zZXRBdHRyaWJ1dGUoXCJ2aWV3Qm94XCIsIHZpZXdCb3gpO1xyXG4gICAgICAgICAgICAvLyBjb3B5IHRoZSBjb250ZW50cyBvZiB0aGUgY2xvbmUgaW50byB0aGUgZnJhZ21lbnRcclxuICAgICAgICAgICAgZm9yICgvLyBjbG9uZSB0aGUgdGFyZ2V0XHJcbiAgICAgICAgICAgICAgICB2YXIgY2xvbmUgPSB0YXJnZXQuY2xvbmVOb2RlKCEwKTsgY2xvbmUuY2hpbGROb2Rlcy5sZW5ndGg7KSB7XHJcbiAgICAgICAgICAgICAgICBmcmFnbWVudC5hcHBlbmRDaGlsZChjbG9uZS5maXJzdENoaWxkKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvLyBhcHBlbmQgdGhlIGZyYWdtZW50IGludG8gdGhlIHN2Z1xyXG4gICAgICAgICAgICBwYXJlbnQuYXBwZW5kQ2hpbGQoZnJhZ21lbnQpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGZ1bmN0aW9uIGxvYWRyZWFkeXN0YXRlY2hhbmdlKHhocikge1xyXG4gICAgICAgIC8vIGxpc3RlbiB0byBjaGFuZ2VzIGluIHRoZSByZXF1ZXN0XHJcbiAgICAgICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICAgICAgLy8gaWYgdGhlIHJlcXVlc3QgaXMgcmVhZHlcclxuICAgICAgICAgICAgaWYgKDQgPT09IHhoci5yZWFkeVN0YXRlKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBnZXQgdGhlIGNhY2hlZCBodG1sIGRvY3VtZW50XHJcbiAgICAgICAgICAgICAgICB2YXIgY2FjaGVkRG9jdW1lbnQgPSB4aHIuX2NhY2hlZERvY3VtZW50O1xyXG4gICAgICAgICAgICAgICAgLy8gZW5zdXJlIHRoZSBjYWNoZWQgaHRtbCBkb2N1bWVudCBiYXNlZCBvbiB0aGUgeGhyIHJlc3BvbnNlXHJcbiAgICAgICAgICAgICAgICBjYWNoZWREb2N1bWVudCB8fCAoY2FjaGVkRG9jdW1lbnQgPSB4aHIuX2NhY2hlZERvY3VtZW50ID0gZG9jdW1lbnQuaW1wbGVtZW50YXRpb24uY3JlYXRlSFRNTERvY3VtZW50KFwiXCIpLFxyXG4gICAgICAgICAgICAgICAgICAgIGNhY2hlZERvY3VtZW50LmJvZHkuaW5uZXJIVE1MID0geGhyLnJlc3BvbnNlVGV4dCwgeGhyLl9jYWNoZWRUYXJnZXQgPSB7fSksIC8vIGNsZWFyIHRoZSB4aHIgZW1iZWRzIGxpc3QgYW5kIGVtYmVkIGVhY2ggaXRlbVxyXG4gICAgICAgICAgICAgICAgICAgIHhoci5fZW1iZWRzLnNwbGljZSgwKS5tYXAoZnVuY3Rpb24gKGl0ZW0pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gZ2V0IHRoZSBjYWNoZWQgdGFyZ2V0XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0YXJnZXQgPSB4aHIuX2NhY2hlZFRhcmdldFtpdGVtLmlkXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gZW5zdXJlIHRoZSBjYWNoZWQgdGFyZ2V0XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldCB8fCAodGFyZ2V0ID0geGhyLl9jYWNoZWRUYXJnZXRbaXRlbS5pZF0gPSBjYWNoZWREb2N1bWVudC5nZXRFbGVtZW50QnlJZChpdGVtLmlkKSksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBlbWJlZCB0aGUgdGFyZ2V0IGludG8gdGhlIHN2Z1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZW1iZWQoaXRlbS5wYXJlbnQsIGl0ZW0uc3ZnLCB0YXJnZXQpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSwgLy8gdGVzdCB0aGUgcmVhZHkgc3RhdGUgY2hhbmdlIGltbWVkaWF0ZWx5XHJcbiAgICAgICAgICAgIHhoci5vbnJlYWR5c3RhdGVjaGFuZ2UoKTtcclxuICAgIH1cclxuICAgIGZ1bmN0aW9uIHN2ZzRldmVyeWJvZHkocmF3b3B0cykge1xyXG4gICAgICAgIGZ1bmN0aW9uIG9uaW50ZXJ2YWwoKSB7XHJcbiAgICAgICAgICAgIC8vIHdoaWxlIHRoZSBpbmRleCBleGlzdHMgaW4gdGhlIGxpdmUgPHVzZT4gY29sbGVjdGlvblxyXG4gICAgICAgICAgICBmb3IgKC8vIGdldCB0aGUgY2FjaGVkIDx1c2U+IGluZGV4XHJcbiAgICAgICAgICAgICAgICB2YXIgaW5kZXggPSAwOyBpbmRleCA8IHVzZXMubGVuZ3RoOykge1xyXG4gICAgICAgICAgICAgICAgLy8gZ2V0IHRoZSBjdXJyZW50IDx1c2U+XHJcbiAgICAgICAgICAgICAgICB2YXIgdXNlID0gdXNlc1tpbmRleF0sIHBhcmVudCA9IHVzZS5wYXJlbnROb2RlLCBzdmcgPSBnZXRTVkdBbmNlc3RvcihwYXJlbnQpLCBzcmMgPSB1c2UuZ2V0QXR0cmlidXRlKFwieGxpbms6aHJlZlwiKSB8fCB1c2UuZ2V0QXR0cmlidXRlKFwiaHJlZlwiKTtcclxuICAgICAgICAgICAgICAgIGlmICghc3JjICYmIG9wdHMuYXR0cmlidXRlTmFtZSAmJiAoc3JjID0gdXNlLmdldEF0dHJpYnV0ZShvcHRzLmF0dHJpYnV0ZU5hbWUpKSxcclxuICAgICAgICAgICAgICAgICAgICBzdmcgJiYgc3JjKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHBvbHlmaWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghb3B0cy52YWxpZGF0ZSB8fCBvcHRzLnZhbGlkYXRlKHNyYywgc3ZnLCB1c2UpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyByZW1vdmUgdGhlIDx1c2U+IGVsZW1lbnRcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudC5yZW1vdmVDaGlsZCh1c2UpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gcGFyc2UgdGhlIHNyYyBhbmQgZ2V0IHRoZSB1cmwgYW5kIGlkXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgc3JjU3BsaXQgPSBzcmMuc3BsaXQoXCIjXCIpLCB1cmwgPSBzcmNTcGxpdC5zaGlmdCgpLCBpZCA9IHNyY1NwbGl0LmpvaW4oXCIjXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWYgdGhlIGxpbmsgaXMgZXh0ZXJuYWxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1cmwubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZ2V0IHRoZSBjYWNoZWQgeGhyIHJlcXVlc3RcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgeGhyID0gcmVxdWVzdHNbdXJsXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBlbnN1cmUgdGhlIHhociByZXF1ZXN0IGV4aXN0c1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHhociB8fCAoeGhyID0gcmVxdWVzdHNbdXJsXSA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpLCB4aHIub3BlbihcIkdFVFwiLCB1cmwpLCB4aHIuc2VuZCgpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB4aHIuX2VtYmVkcyA9IFtdKSwgLy8gYWRkIHRoZSBzdmcgYW5kIGlkIGFzIGFuIGl0ZW0gdG8gdGhlIHhociBlbWJlZHMgbGlzdFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB4aHIuX2VtYmVkcy5wdXNoKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudDogcGFyZW50LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3ZnOiBzdmcsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogaWRcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSksIC8vIHByZXBhcmUgdGhlIHhociByZWFkeSBzdGF0ZSBjaGFuZ2UgZXZlbnRcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9hZHJlYWR5c3RhdGVjaGFuZ2UoeGhyKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZW1iZWQgdGhlIGxvY2FsIGlkIGludG8gdGhlIHN2Z1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVtYmVkKHBhcmVudCwgc3ZnLCBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gaW5jcmVhc2UgdGhlIGluZGV4IHdoZW4gdGhlIHByZXZpb3VzIHZhbHVlIHdhcyBub3QgXCJ2YWxpZFwiXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICArK2luZGV4LCArK251bWJlck9mU3ZnVXNlRWxlbWVudHNUb0J5cGFzcztcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gaW5jcmVhc2UgdGhlIGluZGV4IHdoZW4gdGhlIHByZXZpb3VzIHZhbHVlIHdhcyBub3QgXCJ2YWxpZFwiXHJcbiAgICAgICAgICAgICAgICAgICAgKytpbmRleDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAvLyBjb250aW51ZSB0aGUgaW50ZXJ2YWxcclxuICAgICAgICAgICAgKCF1c2VzLmxlbmd0aCB8fCB1c2VzLmxlbmd0aCAtIG51bWJlck9mU3ZnVXNlRWxlbWVudHNUb0J5cGFzcyA+IDApICYmIHJlcXVlc3RBbmltYXRpb25GcmFtZShvbmludGVydmFsLCA2Nyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZhciBwb2x5ZmlsbCwgb3B0cyA9IE9iamVjdChyYXdvcHRzKSwgbmV3ZXJJRVVBID0gL1xcYlRyaWRlbnRcXC9bNTY3XVxcYnxcXGJNU0lFICg/Ojl8MTApXFwuMFxcYi8sIHdlYmtpdFVBID0gL1xcYkFwcGxlV2ViS2l0XFwvKFxcZCspXFxiLywgb2xkZXJFZGdlVUEgPSAvXFxiRWRnZVxcLzEyXFwuKFxcZCspXFxiLywgZWRnZVVBID0gL1xcYkVkZ2VcXC8uKFxcZCspXFxiLywgaW5JZnJhbWUgPSB3aW5kb3cudG9wICE9PSB3aW5kb3cuc2VsZjtcclxuICAgICAgICBwb2x5ZmlsbCA9IFwicG9seWZpbGxcIiBpbiBvcHRzID8gb3B0cy5wb2x5ZmlsbCA6IG5ld2VySUVVQS50ZXN0KG5hdmlnYXRvci51c2VyQWdlbnQpIHx8IChuYXZpZ2F0b3IudXNlckFnZW50Lm1hdGNoKG9sZGVyRWRnZVVBKSB8fCBbXSlbMV0gPCAxMDU0NyB8fCAobmF2aWdhdG9yLnVzZXJBZ2VudC5tYXRjaCh3ZWJraXRVQSkgfHwgW10pWzFdIDwgNTM3IHx8IGVkZ2VVQS50ZXN0KG5hdmlnYXRvci51c2VyQWdlbnQpICYmIGluSWZyYW1lO1xyXG4gICAgICAgIC8vIGNyZWF0ZSB4aHIgcmVxdWVzdHMgb2JqZWN0XHJcbiAgICAgICAgdmFyIHJlcXVlc3RzID0ge30sIHJlcXVlc3RBbmltYXRpb25GcmFtZSA9IHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHwgc2V0VGltZW91dCwgdXNlcyA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKFwidXNlXCIpLCBudW1iZXJPZlN2Z1VzZUVsZW1lbnRzVG9CeXBhc3MgPSAwO1xyXG4gICAgICAgIC8vIGNvbmRpdGlvbmFsbHkgc3RhcnQgdGhlIGludGVydmFsIGlmIHRoZSBwb2x5ZmlsbCBpcyBhY3RpdmVcclxuICAgICAgICBwb2x5ZmlsbCAmJiBvbmludGVydmFsKCk7XHJcbiAgICB9XHJcbiAgICBmdW5jdGlvbiBnZXRTVkdBbmNlc3Rvcihub2RlKSB7XHJcbiAgICAgICAgZm9yICh2YXIgc3ZnID0gbm9kZTsgXCJzdmdcIiAhPT0gc3ZnLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgJiYgKHN2ZyA9IHN2Zy5wYXJlbnROb2RlKTspIHsgfVxyXG4gICAgICAgIHJldHVybiBzdmc7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gc3ZnNGV2ZXJ5Ym9keTtcclxufSk7Il19
